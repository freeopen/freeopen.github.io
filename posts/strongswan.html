<!DOCTYPE html>
<html lang="en">
<head>
          <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <!-- Enable responsiveness on mobile devices-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

        <title>Freeopen - 一支红杏出墙来</title>
        <link rel="stylesheet" href="https://freeopen.github.io/theme/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://freeopen.github.io/theme/css/main.css" />
        <link rel="stylesheet" href="https://freeopen.github.io/theme/assets/academicons/css/academicons.min.css" />
        <link rel="stylesheet" href="https://freeopen.github.io/theme/assets/font-awesome/css/font-awesome.min.css" />
        <link rel="stylesheet" href="https://freeopen.github.io/theme/assets/fonts-googleapis/css/googleapi-fonts.css" />

        






</head>

<body id="index" class="theme-myblue" data-spy="scroll" data-target="#post_toc">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12 col-lg">
        <nav class="navbar navbar-expand-lg navbar-light sidebar" role="navigation">
          <a class="sidebar-about" href="https://freeopen.github.io/">Freeopen</a>
          <button class="navbar-toggler " type="button" data-toggle="collapse" data-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
          </button>
          <nav class="collapse navbar-collapse sidebar-nav flex-column" id="navbarNav">

              <a class="nav-link" href="https://freeopen.github.io/pages/guan-yu-zhe-li.html">关于这里</a>
              <a class="nav-link" href="https://freeopen.github.io/pages/zou-guo-lu-guo.html">走过路过</a>

              <a class="nav-link" href="https://freeopen.github.io/category/bian-cheng-zhi-hui.html">编程智慧</a>
              <a class="nav-link" href="https://freeopen.github.io/category/ji-qi-xue-xi.html">机器学习</a>
              <a class="nav-link" href="https://freeopen.github.io/category/shu-xue-za-tan.html">数学杂谈</a>
              <a class="nav-link" href="https://freeopen.github.io/category/su-cha-shou-ce.html">速查手册</a>
            <div class="sidebar-icons">
              <hr>
                <a href="" title="Atom feed" target="_blank" 
                    style="display: inline; padding: 0px 0px 0px 0; margin: 3px 4px 0 0; white-space: nowrap; font-size:2.5em;">
                  <i class="fa fa-rss-square"></i>
                </a>
                <a href="https://github.com/freeopen" title="Software I released on Github" 
                      target="_blank" style="display: inline; padding: 0px 0px 0px 0; margin: 3px 4px 0 0; white-space: nowrap; font-size:2.5em;"><i class="fa fa-github-square"></i> </a>
                <a href="Mailto:freeopen@163.com" title="My email" 
                    target="_blank" style="display: inline; padding: 0px 0px 0px 0;
                    margin: 3px 4px 0 0; white-space: nowrap; font-size:2.5em;"><i
                  class="fa fa-envelope-square"></i> </a>

            </div>
          </nav>

        </nav>

      </div>

      <div class="col-12 col-lg-7" role="main">
        <div id="content" class="content">
          <div class="post">
<section id="content" class="body">
  <header>
    <h1 class="entry-title">一支红杏出墙来</h2>
 
  </header>
  <div class="post-info">

    <span>2021-04-04</span>


    <span>| By             <a class="url fn" href="https://freeopen.github.io/author/freeopen.html">freeopen</a>
    </span>

    <span>
      | 分类于 <a href="https://freeopen.github.io/category/bian-cheng-zhi-hui.html">编程智慧</a>
    </span>

  </div><!-- /.post-info -->
  <div class="post content">
    <ul>
<li>1CPU,512M</li>
<li>CentOS 8.2 aliyun</li>
<li>StrongSwan 5.8.2 </li>
</ul>
<h2 id="yi-zhun-bei-jie-duan">一、准备阶段</h2>
<p>新建服务器时，不选择 <code>安全加固</code></p>
<p>首先卸载阿里云安骑士</p>
<div class="highlight"><pre><span></span><code>wget http://update.aegis.aliyun.com/download/uninstall.sh
<span class="nb">source</span> ./uninstall.sh
wget http://update.aegis.aliyun.com/download/quartz_uninstall.sh
<span class="nb">source</span> ./quartz_uninstall.sh
</code></pre></div>
<p>删除安骑士残留文件</p>
<div class="highlight"><pre><span></span><code>pkill aliyun-service
rm -fr /etc/init.d/agentwatch /usr/sbin/aliyun-service
rm -rf /usr/local/aegis*
</code></pre></div>
<p>以 root 用户登录, 安装 epel 源，阿里云centos 8 的镜像比较新，不需要 update, 费流量。</p>
<p><code>dnf install epel-release</code></p>
<p>安装必备软件</p>
<div class="highlight"><pre><span></span><code>dnf install nginx certbot iptables-services crontab strongswan
<span class="c1">#nginx开机启动</span>
systemctl <span class="nb">enable</span> nginx
<span class="c1">#启动nginx</span>
systemctl restart nginx
</code></pre></div>
<h2 id="er-shen-qing-ssl-zheng-shu">二、申请 ssl 证书</h2>
<p>StrongSwan IPsec IKEv2 连接需要用到服务器证书，用于验证服务器身份。由于自签发证书不受操作系统信任，我们需要申请 <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a> 免费证书。
申请证书需要有域名，提前将域名解析到你的vps地址。</p>
<p>方式一，必须打开nginx, 能访问80端口</p>
<div class="highlight"><pre><span></span><code><span class="c1">#在web根目录创建临时目录</span>
mkdir -p /usr/share/nginx/html/.well-known/acme-challenge

<span class="c1">#--webroot 参数:指定使用临时目录的方式. -w 参数:指定后面-d 域名所在的根目录, 如果一次申请多个域的, 可以附加更多 -w...-d... 这段.</span>
certbot certonly --webroot --email xxx@xxx.com -w /usr/share/nginx/html -d xx.xxx.com
</code></pre></div>
<p>方式二，不需要打开nginx，能访问80端口</p>
<div class="highlight"><pre><span></span><code>certbot certonly --rsa-key-size <span class="m">2048</span> --standalone --agree-tos --no-eff-email --email xxx@gmail.com -d xxx.xxx.com
</code></pre></div>
<h3 id="certbot-zheng-shu-zi-dong-geng-xin">Certbot 证书自动更新</h3>
<p>由于 <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a> 证书只有90天有效期，为避免过期，需要启用自动续期。自动续期由定时任务完成。</p>
<h4>方案一</h4>
<p>编辑定时任务配置, 写入下面红色内容，这段的意思是每月28号凌晨3点运行 certbot renew 命令给证书续期，如果续期成功则重启 nginx 和 strongswan 服务。</p>
<p><code>vim  /etc/crontab</code></p>
<div class="highlight"><pre><span></span><code><span class="nv">SHELL</span><span class="o">=</span>/bin/bash
<span class="nv">PATH</span><span class="o">=</span>/sbin:/bin:/usr/sbin:/usr/bin
<span class="nv">MAILTO</span><span class="o">=</span>root

<span class="c1"># For details see man 4 crontabs</span>

<span class="c1"># Example of job definition:</span>
<span class="c1"># .---------------- minute (0 - 59)</span>
<span class="c1"># |  .------------- hour (0 - 23)</span>
<span class="c1"># |  |  .---------- day of month (1 - 31)</span>
<span class="c1"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span>
<span class="c1"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span>
<span class="c1"># |  |  |  |  |</span>
<span class="c1"># *  *  *  *  * user-name  command to be executed</span>
<span class="m">0</span> <span class="m">3</span> <span class="m">28</span> * * root certbot renew --quiet --deploy-hook <span class="s2">"systemctl restart nginx &amp;&amp; systemctl restart strongswan"</span>
</code></pre></div>
<p>加载定时任务配置，使之生效。</p>
<p><code>crontab /etc/crontab</code></p>
<p>（注：这种方法我没成功）</p>
<h4>方案二</h4>
<div class="highlight"><pre><span></span><code>$ cat /etc/cron.d/certbot

<span class="c1"># /etc/cron.d/certbot: crontab entries for the certbot package</span>
<span class="c1">#</span>
<span class="c1"># Upstream recommends attempting renewal twice a day</span>
<span class="c1">#</span>
<span class="c1"># Eventually, this will be an opportunity to validate certificates</span>
<span class="c1"># haven't been revoked, etc.  Renewal will only occur if expiration</span>
<span class="c1"># is within 30 days.</span>
<span class="nv">SHELL</span><span class="o">=</span>/bin/sh
<span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

<span class="m">0</span> */12 * * * root <span class="nb">test</span> -x /usr/bin/certbot  -a <span class="se">\!</span> -d /run/systemd/system <span class="o">&amp;&amp;</span>  perl -e <span class="s1">'sleep int(rand(43200))'</span> <span class="o">&amp;&amp;</span>  certbot -q renew
</code></pre></div>
<p>意思说每天测试一下，证书是否在未来30天过期，如果过期就更新，否则什么也不做。</p>
<p>（我未亲测）</p>
<h4>方案三</h4>
<p>安装了certbot nginx 插件后，执行一次证书更新后，发现输出的提示语中有句，certbot证书已能自动更新，仔细查看配置，发现生成了一个证书更新服务，名字叫certbot-renew, 由两个文件组成，certbot-renew.service 和 certbot-renew.timer。基本逻辑是每12小时，检查一下证书更新。</p>
<p>服务并没自动启动，须手动启动这个服务，我目前采用的这个方案。同时在crontab中设置每月指定时间重启一次 strongswan 服务。</p>
<p>注：证书更新后，vpn连接时还是会报错，说证书无效，原因是 strongswan 缓存的是旧的过期证书，重新启动一下 strongswan 即可。</p>
<h2 id="san-an-zhuang-strongswan_1">三、安装 strongswan</h2>
<p>注意， 本配置适用于5.8.2以上，基于 swanctl 配置。</p>
<p><code>vim /etc/strongswan/swanctl/conf.d/xx.xxx.com.conf</code></p>
<div class="highlight"><pre><span></span><code>connections {
    ikev2-eap-mschapv2 {
        version = 2
        unique = never
        rekey_time = 0s
        fragmentation = yes
        dpd_delay = 60s
        send_cert = always
        pools = ipv4-addrs, ipv6-addrs
        proposals = aes256-sha256-prfsha256-modp2048, aes256gcm16-prfsha384-modp1024, default
        local_addrs = %any
        local {
            certs = cert.pem
            id = xx.xxx.com
        }
        remote {
            auth = eap-mschapv2
            eap_id = %any
        }
        children {
            ikev2-eap-mschapv2 {
                local_ts = 0.0.0.0/0,::/0
                rekey_time = 0s
                dpd_action = clear
                esp_proposals = aes256-sha256, aes128-sha1, default
            }
        }
    }
}
pools {
    ipv4-addrs {
        addrs = 10.10.0.0/24
        dns = 8.8.8.8,8.8.4.4,114.114.114.114
    }
    ipv6-addrs {
        addrs = fec1::0/24
        dns = 2001:4860:4860::8888,2606:4700:4700::1111
    }
}
secrets {
    private-xxx {
        file = privkey.pem
    }   
    eap-user1 {
        id = user1
        secret = "123456"
    }
    eap-user2 {
        id = user2
        secret = "654321"
    }
}
</code></pre></div>
<p>高亮部分中的 xx.xxx.com 替换为上面申请证书时用的域名， private-xxx 中的 xxx 随意，不要有符号，eap-user1 和 id = user1 中的 user1 替换为你想登录vpn使用的账号，secret = &ldquo;123456&rdquo; 改为你的密码。
如需添加多个用户，复制 eap-user1 { &hellip; } 段粘贴到下面，按上面规则设置新的用户名和密码即可。</p>
<p>安装证书，创建证书软链接到 strongswan 的对应目录。</p>
<div class="highlight"><pre><span></span><code>ln -s /etc/letsencrypt/live/xx.xxx.com/cert.pem /etc/strongswan/swanctl/x509/cert.pem
ln -s /etc/letsencrypt/live/xx.xxx.com/privkey.pem /etc/strongswan/swanctl/private/privkey.pem
ln -s /etc/letsencrypt/live/xx.xxx.com/chain.pem /etc/strongswan/swanctl/x509ca/ca.pem
</code></pre></div>
<p>证书安装完成
重启服务</p>
<p><code>systemctl restart strongswan</code></p>
<p>开启内核转发</p>
<p><code>vim /etc/sysctl.conf</code></p>
<p>用下面内容替换配置文件中同名的项，如果没有则新增。</p>
<div class="highlight"><pre><span></span><code><span class="c1">#开启内核ipv4转发</span>
net.ipv4.ip_forward <span class="o">=</span> <span class="m">1</span>
net.ipv4.conf.all.accept_redirects <span class="o">=</span> <span class="m">0</span>
net.ipv4.conf.all.send_redirects <span class="o">=</span> <span class="m">0</span>

<span class="c1">#开启内核ipv6转发</span>
net.ipv6.conf.all.forwarding <span class="o">=</span> <span class="m">1</span>
</code></pre></div>
<p>重新加载配置</p>
<p><code>sysctl -p</code></p>
<p>配置防火墙</p>
<p><code>vim /etc/sysconfig/iptables</code></p>
<p>在合适的位置添加以下规则, 注意顺序, 新增 屏蔽 安骑士 ip 脚本。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># sample configuration for iptables service</span>
<span class="c1"># you can edit this manually or use system-config-firewall</span>
<span class="c1"># please do not ask us to add additional ports/services to this default configuration</span>
*nat
:PREROUTING ACCEPT <span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
:INPUT ACCEPT <span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
:POSTROUTING ACCEPT <span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
:OUTPUT ACCEPT <span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
-A POSTROUTING -s <span class="m">10</span>.10.0.0/24 -o eth0 -m policy --dir out --pol ipsec -j ACCEPT
-A POSTROUTING -s <span class="m">10</span>.10.0.0/24 -o eth0 -j MASQUERADE
COMMIT
*filter
:INPUT ACCEPT <span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
:FORWARD ACCEPT <span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
:OUTPUT ACCEPT <span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -s <span class="m">140</span>.205.201.0/24 -j DROP
-A INPUT -s <span class="m">140</span>.205.255.0/24 -j DROP
-A INPUT -p tcp -m state --state NEW -m tcp --dport <span class="m">22</span> -j ACCEPT
-A INPUT -p tcp -m tcp --dport <span class="m">80</span> -j ACCEPT
-A INPUT -p tcp -m tcp --dport <span class="m">443</span> -j ACCEPT
-A INPUT -i eth0 -p ah -j ACCEPT
-A INPUT -i eth0 -p esp -j ACCEPT
-A INPUT -i eth0 -p udp -m udp --dport <span class="m">500</span> -j ACCEPT
-A INPUT -i eth0 -p udp -m udp --dport <span class="m">4500</span> -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -i eth0 -m policy --dir <span class="k">in</span> --pol ipsec -j ACCEPT
-A FORWARD -d <span class="m">10</span>.10.0.0/24 -o eth0 -m policy --dir out --pol ipsec -j ACCEPT
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
</code></pre></div>
<p>重启防火墙，使规则生效。</p>
<p><code>systemctl restart iptables</code></p>
<p>配置strongswan 输出日志，方便测试，测试完成后，关闭该日志</p>
<p><code>vim /etc/strongswan/strongswan.d/charon.conf</code></p>
<div class="highlight"><pre><span></span><code>charon <span class="o">{</span>
    filelog <span class="o">{</span>
        charon-debug-log <span class="o">{</span>
            <span class="nv">path</span> <span class="o">=</span> /var/log/charon_debug.log
            <span class="nv">time_format</span> <span class="o">=</span> %b %e %T
            <span class="nv">default</span> <span class="o">=</span> <span class="m">2</span>
            <span class="nv">mgr</span> <span class="o">=</span> <span class="m">0</span>
            <span class="nv">net</span> <span class="o">=</span> <span class="m">1</span>
            <span class="nv">enc</span> <span class="o">=</span> <span class="m">1</span>
            <span class="nv">asn</span> <span class="o">=</span> <span class="m">1</span>
            <span class="nv">job</span> <span class="o">=</span> <span class="m">1</span>
            <span class="nv">ike_name</span> <span class="o">=</span> yes
            <span class="nv">append</span> <span class="o">=</span> no
            <span class="nv">flush_line</span> <span class="o">=</span> yes
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">#这里是其它设置......</span>
<span class="o">}</span>
</code></pre></div>
<p>启动strongswan</p>
<p><code>systemctl start strongswan</code></p>
<h2 id="si-zui-hou-zhuang-tai-jian-cha-ji-ce-shi">四、最后状态检查 及 测试</h2>
<div class="highlight"><pre><span></span><code>systemctl status nginx
systemctl status iptables
systemctl status strongswan
</code></pre></div>
<p>到阿里云控制台打开白名单，包含：</p>
<div class="highlight"><pre><span></span><code>tcp 500
tcp 4500
全部 GRE
</code></pre></div>
<p>windows  macos ios 直接配置 vpn即可，</p>
<p>Android 系统需要下载客户端程序，前往官网下载 <a href="https://download.strongswan.org/Android/?C=M;O=D">最新版 apk 程序</a>。
测试完成后，记得关闭 strongswan 日志, 重启 strongswan。</p>
<p><code>systemctl restart strongswan</code></p>
<p>设置开机自启动，完工。</p>
<div class="highlight"><pre><span></span><code>systemctl enable iptables
systemctl enable strongswan
</code></pre></div>
<h2 id="wu-wei-hu">五、维护</h2>
<p>查看证书情况</p>
<p><code>certbot certificates</code></p>
<p>证书手动更新</p>
<p><code>certbot renew --cert-name domain --dry-run</code></p>
<p><code>certbot --nginx certonly -n -d domain</code></p>
<p>第二种更新方法须安装 <code>python3-certbot-nginx</code></p>
  </div><!-- /.entry-content -->

  <!-- DISQUS 评论系统 -->

  <!-- giteement评论系统 -->

  <!-- Gitalk 评论 start  -->
  <!-- Link Gitalk 的支持文件  -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

  <div id="gitalk-container"></div>
      <script type="text/javascript">
      var gitalk = new Gitalk({

      // gitalk的主要参数
          clientID: 'a9a5636ca9f9c44f749f',
          clientSecret: 'a1d32a98cb3190ab1978faf73830add15f6179fb',
          repo: 'blog-discuss',
          owner: 'freeopen',
          admin: ['freeopen'],
          id: 'posts/strongswan',
          proxy: 'https://royal-mouse-3637.freeopen.workers.dev/https://github.com/login/oauth/access_token'
      
      });
      gitalk.render('gitalk-container');
  </script>
  <!-- Gitalk end -->

</section>
          </div>

          <footer id="contentinfo" class="footer">
            <div class="footer-inner">
              无节操小广告<a href="https://freeopen.github.io/pages/da-shang.html"> 欢迎打赏 </a>
            </div>
          </footer><!-- /#contentinfo -->
        </div>
      </div>

      <div class="hidden-print hidden-xs hidden-sm hidden-md col-lg" id="post_toc" role="complementary">
        <nav class="sidebar-toc">
<!-- <section id="main_toc"> -->
    <div id="toc"><ul><li><a class="toc-href" href="#yi-zhun-bei-jie-duan" title="一、准备阶段">一、准备阶段</a></li><li><a class="toc-href" href="#er-shen-qing-ssl-zheng-shu" title="二、申请 ssl 证书">二、申请 ssl 证书</a><ul><li><a class="toc-href" href="#certbot-zheng-shu-zi-dong-geng-xin" title="Certbot 证书自动更新">Certbot 证书自动更新</a></li></ul></li><li><a class="toc-href" href="#san-an-zhuang-strongswan_1" title="三、安装 strongswan">三、安装 strongswan</a></li><li><a class="toc-href" href="#si-zui-hou-zhuang-tai-jian-cha-ji-ce-shi" title="四、最后状态检查 及 测试">四、最后状态检查 及 测试</a></li><li><a class="toc-href" href="#wu-wei-hu" title="五、维护">五、维护</a></li></ul></div>
<!-- </section> -->
<!-- </section> -->
        </nav>
      </div>
    </div>
  </div>


<!--  -->
<!--  -->

<script src="https://freeopen.github.io/theme/js/jquery-3.3.1.slim.min.js"></script>
<script src="https://freeopen.github.io/theme/js/popper.min.js"></script>
<script src="https://freeopen.github.io/theme/js/bootstrap.min.js"></script>
</body>
</html>