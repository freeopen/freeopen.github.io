<!DOCTYPE html>
<html lang="en-US">
<head>
  <script src="https://www.freeopen.tech/theme.min.js" integrity="sha384-IpIaa84kOKgkF5EJ0fD/kBe2wtIIsIB60ANGmuJxeA0dz5bSRfwBwp2/QybtQpU2"></script>
  <link rel="stylesheet" href="https://www.freeopen.tech/abridge-blue-switcher.css?h=68f7fa551ed0d7100d16" />
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  <script defer src="https://www.freeopen.tech/abridge-bundle-nosearch.min.js?h=ff8a99b969caffde4dc9" integrity="sha384-TTPczRVfKSqfcvWVXDBLK5BoDc60R8M377TgY55NuBwnZlUPMNQhS2Riir9tqf2c"></script>
  <meta name="base" content="https://www.freeopen.tech" />
  <link rel="alternate" type="application/atom+xml" title="Atom/RSS Feed" href="https://www.freeopen.tech/atom.xml" />
  <meta name="robots" content="index, follow" />
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <title>一支红杏出墙来 | Freeopen</title>
  <meta name="author" content="freeopen" />
  <meta name="copyright" content="Freeopen" />
  <meta name="description" content="基于 IKEv2 的 vpn 服务器搭建教程，该协议最方便的地方是在终端（手机、平板、PC）上使用时，不需要安装客户端，直接用操作系统自带的 vpn 配置一下即可，弱点是服务器端容易被别有用心的防火墙锁定端口" />
  <link rel="canonical" href="https://www.freeopen.tech/centos-vpn/" />
  <meta name="keywords" content="Vpn, Strongswan, Abridge, Abridge.css, Zola, Theme, Zola Theme, getzola, Semantic Html, Fast, lightweight" />
  <meta property="og:url" content="https://www.freeopen.tech/centos-vpn/" />
  <meta name="twitter:url" content="https://www.freeopen.tech/centos-vpn/" />
  <meta property="og:description" content="基于 IKEv2 的 vpn 服务器搭建教程，该协议最方便的地方是在终端（手机、平板、PC）上使用时，不需要安装客户端，直接用操作系统自带的 vpn 配置一下即可，弱点是服务器端容易被别有用心的防火墙锁定端口" />
  <meta name="twitter:description" content="基于 IKEv2 的 vpn 服务器搭建教程，该协议最方便的地方是在终端（手机、平板、PC）上使用时，不需要安装客户端，直接用操作系统自带的 vpn 配置一下即可，弱点是服务器端容易被别有用心的防火墙锁定端口" />
  <meta property="og:title" content="一支红杏出墙来 | Freeopen" />
  <meta name="twitter:title" content="一支红杏出墙来 | Freeopen" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://www.freeopen.tech/banner.png" />
  <meta property="og:image" content="https://www.freeopen.tech/banner.png" />
  <meta property="og:site_name" content="Freeopen" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:type" content="website" />
  <meta property="og:updated_time" content="2021-04-04" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#333333" />
  <meta name="msapplication-TileColor" content="#333333" />
  <link rel="manifest" href="https://www.freeopen.tech/site.webmanifest" />
  <link rel="mask-icon" href="https://www.freeopen.tech/safari-pinned-tab.svg" color="#ff9900" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://www.freeopen.tech/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://www.freeopen.tech/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://www.freeopen.tech/favicon-16x16.png" />
</head>
<body>
  <header>
    <nav>
      <div><h1><a href="https://www.freeopen.tech/"><font color="#f90">F</font>reeopen</a></h1></div>
      <div>
        <ul><li> <h2><a href="https://www.freeopen.tech/about/">关于</a></h2> </li><li> <h2><a href="https://www.freeopen.tech/posts/">文章</a></h2> </li><li> <h2><a href="https://www.freeopen.tech/categories/">分类</a></h2> </li><li> <h2><a href="https://www.freeopen.tech/tags/">标签</a></h2> </li><li class="js"><i type="reset" id="mode" class="svgs adjust"></i></li></ul>
      </div>
    </nav>
  </header>
  <main>
    <article>
        <h1><a href="https://www.freeopen.tech/centos-vpn/">一支红杏出墙来</a></h1>
        <span class="s95"> freeopen<span class="hpad"> </span> 
            2021-04-04
            
            
            <span class="hpad"> </span>
         [<a href="https://www.freeopen.tech/categories/qi-men-dun-jia/">奇门遁甲</a>] #<a href="https://www.freeopen.tech/tags/vpn/">vpn</a> </span>

    <ul>
<li>1CPU,512M</li>
<li>CentOS 8.2 aliyun</li>
<li>StrongSwan 5.8.2 </li>
</ul>
<h2 id="yi-zhun-bei-jie-duan">一、准备阶段</h2>
<p>新建服务器时，不选择 <code>安全加固</code></p>
<p>首先卸载阿里云安骑士</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">wget</span></span><span class="z-meta z-function-call z-arguments z-shell"> http://update.aegis.aliyun.com/download/uninstall.sh</span>
<span class="z-meta z-function-call z-shell"><span class="z-support z-function z-source z-shell">source</span></span><span class="z-meta z-function-call z-arguments z-shell"> ./uninstall.sh</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">wget</span></span><span class="z-meta z-function-call z-arguments z-shell"> http://update.aegis.aliyun.com/download/quartz_uninstall.sh</span>
<span class="z-meta z-function-call z-shell"><span class="z-support z-function z-source z-shell">source</span></span><span class="z-meta z-function-call z-arguments z-shell"> ./quartz_uninstall.sh</span>
</span></code></pre>
<p>删除安骑士残留文件</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">pkill</span></span><span class="z-meta z-function-call z-arguments z-shell"> aliyun-service</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rm</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>fr</span> /etc/init.d/agentwatch /usr/sbin/aliyun-service</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rm</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>rf</span> /usr/local/aegis<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span></span>
</span></code></pre>
<p>以 root 用户登录, 安装 epel 源，阿里云centos 8 的镜像比较新，不需要 update, 费流量。</p>
<p><code>dnf install epel-release</code></p>
<p>安装必备软件</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">dnf</span></span><span class="z-meta z-function-call z-arguments z-shell"> install nginx certbot iptables-services crontab strongswan</span>
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">nginx开机启动</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> enable nginx</span>
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">启动nginx</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> restart nginx</span>
</span></code></pre>
<h2 id="er-shen-qing-ssl-zheng-shu">二、申请 ssl 证书</h2>
<p>StrongSwan IPsec IKEv2 连接需要用到服务器证书，用于验证服务器身份。由于自签发证书不受操作系统信任，我们需要申请 <a rel="noopener nofollow noreferrer" target="_blank" href="https://letsencrypt.org/">Let’s Encrypt</a> 免费证书。
申请证书需要有域名，提前将域名解析到你的vps地址。</p>
<p>方式一，必须打开nginx, 能访问80端口</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">在web根目录创建临时目录</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mkdir</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> /usr/share/nginx/html/.well-known/acme-challenge</span>
 
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">--webroot 参数:指定使用临时目录的方式. -w 参数:指定后面-d 域名所在的根目录, 如果一次申请多个域的, 可以附加更多 -w...-d... 这段.</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">certbot</span></span><span class="z-meta z-function-call z-arguments z-shell"> certonly<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>webroot</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>email</span> xxx@xxx.com<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>w</span> /usr/share/nginx/html<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>d</span> xx.xxx.com</span>
</span></code></pre>
<p>方式二，不需要打开nginx，能访问80端口</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">certbot</span></span><span class="z-meta z-function-call z-arguments z-shell"> certonly<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>rsa-key-size</span> 2048<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>standalone</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>agree-tos</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>no-eff-email</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>email</span> xxx@gmail.com<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>d</span> xxx.xxx.com</span>
</span></code></pre>
<h3 id="certbot-zheng-shu-zi-dong-geng-xin">Certbot 证书自动更新</h3>
<p>由于 <a rel="noopener nofollow noreferrer" target="_blank" href="https://letsencrypt.org/">Let’s Encrypt</a> 证书只有90天有效期，为避免过期，需要启用自动续期。自动续期由定时任务完成。</p>
<h4 id="fang-an-yi">方案一</h4>
<p>编辑定时任务配置, 写入下面红色内容，这段的意思是每月28号凌晨3点运行 certbot renew 命令给证书续期，如果续期成功则重启 nginx 和 strongswan 服务。</p>
<p><code>vim  /etc/crontab</code></p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-variable z-other z-readwrite z-assignment z-shell">SHELL</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">/bin/bash</span>
<span class="z-variable z-other z-readwrite z-assignment z-shell">PATH</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">/sbin:/bin:/usr/sbin:/usr/bin</span>
<span class="z-variable z-other z-readwrite z-assignment z-shell">MAILTO</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">root</span>
 
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> For details see man 4 crontabs</span><span class="z-comment z-line z-number-sign z-shell">
</span> 
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Example of job definition:</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> .---------------- minute (0 - 59)</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> |  .------------- hour (0 - 23)</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> |  |  .---------- day of month (1 - 31)</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> |  |  |  |  |</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> *  *  *  *  * user-name  command to be executed</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell"> 3 28 <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span> root certbot renew<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>quiet</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>deploy-hook</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>systemctl restart nginx &amp;&amp; systemctl restart strongswan<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span></code></pre>
<p>加载定时任务配置，使之生效。</p>
<p><code>crontab /etc/crontab</code></p>
<h4 id="fang-an-er">方案二</h4>
<pre class="z-code"><code><span class="z-text z-plain">$ cat /etc/cron.d/certbot

# /etc/cron.d/certbot: crontab entries for the certbot package
#
# Upstream recommends attempting renewal twice a day
#
# Eventually, this will be an opportunity to validate certificates
# haven&#39;t been revoked, etc.  Renewal will only occur if expiration
# is within 30 days.
SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

0 */12 * * * root test -x /usr/bin/certbot  -a \! -d /run/systemd/system &amp;&amp;  perl -e &#39;sleep int(rand(43200))&#39; &amp;&amp;  certbot -q renew
</span></code></pre>
<p>意思说每天测试一下，证书是否在未来30天过期，如果过期就更新，否则什么也不做。</p>
<h4 id="fang-an-san">方案三</h4>
<p>安装了certbot nginx 插件后，执行一次证书更新后，发现输出的提示语中有句，certbot证书已能自动更新，仔细查看配置，发现生成了一个证书更新服务，名字叫certbot-renew, 由两个文件组成，certbot-renew.service 和 certbot-renew.timer。基本逻辑是每12小时，检查一下证书更新。</p>
<p>服务并没自动启动，须手动启动这个服务，我目前采用的这个方案。同时在crontab中设置每月指定时间重启一次 strongswan 服务。</p>
<p><code>systemctl enable --now certbot-renew.timer</code></p>
<p>注：证书更新后，vpn连接时还是会报错，说证书无效，原因是 strongswan 缓存的是旧的过期证书，重新启动一下 strongswan 即可。编辑 /etc/letsencrypt/renewal/example.com.conf 文件，在最后一行增加，将会在证书更新后，重新启动 strongswan.</p>
<pre class="z-code"><code><span class="z-text z-plain">renew_hook = systemctl restart strongswan
</span></code></pre>
<h2 id="san-an-zhuang-strongswan">三、安装 strongswan</h2>
<p>注意， 本配置适用于5.8.2以上，基于 swanctl 配置。</p>
<p><code>vim /etc/strongswan/swanctl/conf.d/xx.xxx.com.conf</code></p>
<pre class="z-code"><code><span class="z-text z-plain">connections {
    ikev2-eap-mschapv2 {
        version = 2
        unique = never
        rekey_time = 0s
        fragmentation = yes
        dpd_delay = 60s
        send_cert = always
        pools = ipv4-addrs, ipv6-addrs
        proposals = aes256-sha256-prfsha256-modp2048, aes256gcm16-prfsha384-modp1024, default
        local_addrs = %any
        local {
            certs = cert.pem
            id = xx.xxx.com
        }
        remote {
            auth = eap-mschapv2
            eap_id = %any
        }
        children {
            ikev2-eap-mschapv2 {
                local_ts = 0.0.0.0/0,::/0
                rekey_time = 0s
                dpd_action = clear
                esp_proposals = aes256-sha256, aes128-sha1, default
            }
        }
    }
}
pools {
    ipv4-addrs {
        addrs = 10.10.0.0/24
        dns = 8.8.8.8,8.8.4.4,114.114.114.114
    }
    ipv6-addrs {
        addrs = fec1::0/24
        dns = 2001:4860:4860::8888,2606:4700:4700::1111
    }
}
secrets {
    private-xxx {
        file = privkey.pem
    }   
    eap-user1 {
        id = user1
        secret = &quot;123456&quot;
    }
    eap-user2 {
        id = user2
        secret = &quot;654321&quot;
    }
}
</span></code></pre>
<p>高亮部分中的 xx.xxx.com 替换为上面申请证书时用的域名， private-xxx 中的 xxx 随意，不要有符号，eap-user1 和 id = user1 中的 user1 替换为你想登录vpn使用的账号，secret = “123456” 改为你的密码。
如需添加多个用户，复制 eap-user1 { … } 段粘贴到下面，按上面规则设置新的用户名和密码即可。</p>
<p>安装证书，创建证书软链接到 strongswan 的对应目录。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ln</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /etc/letsencrypt/live/xx.xxx.com/cert.pem /etc/strongswan/swanctl/x509/cert.pem</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ln</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /etc/letsencrypt/live/xx.xxx.com/privkey.pem /etc/strongswan/swanctl/private/privkey.pem</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ln</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> /etc/letsencrypt/live/xx.xxx.com/chain.pem /etc/strongswan/swanctl/x509ca/ca.pem</span>
</span></code></pre>
<p>证书安装完成
重启服务</p>
<p><code>systemctl restart strongswan</code></p>
<p>开启内核转发</p>
<p><code>vim /etc/sysctl.conf</code></p>
<p>用下面内容替换配置文件中同名的项，如果没有则新增。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">开启内核ipv4转发</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">net.ipv4.ip_forward</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 1</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">net.ipv4.conf.all.accept_redirects</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 0</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">net.ipv4.conf.all.send_redirects</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 0</span>
 
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">开启内核ipv6转发</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">net.ipv6.conf.all.forwarding</span></span><span class="z-meta z-function-call z-arguments z-shell"> = 1</span>
</span></code></pre>
<p>重新加载配置</p>
<p><code>sysctl -p</code></p>
<p>配置防火墙</p>
<p><code>vim /etc/sysconfig/iptables</code></p>
<p>在合适的位置添加以下规则, 注意顺序, 新增 屏蔽 安骑士 ip 脚本。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> sample configuration for iptables service</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> you can edit this manually or use system-config-firewall</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> please do not ask us to add additional ports/services to this default configuration</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">*nat</span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">:PREROUTING</span></span><span class="z-meta z-function-call z-arguments z-shell"> ACCEPT <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>0:0<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">:INPUT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ACCEPT <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>0:0<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">:POSTROUTING</span></span><span class="z-meta z-function-call z-arguments z-shell"> ACCEPT <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>0:0<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">:OUTPUT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ACCEPT <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>0:0<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> POSTROUTING<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> 10.10.0.0/24<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>o</span> eth0<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> policy<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dir</span> out<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>pol</span> ipsec<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> ACCEPT</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> POSTROUTING<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> 10.10.0.0/24<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>o</span> eth0<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> MASQUERADE</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">COMMIT</span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">*filter</span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">:INPUT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ACCEPT <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>0:0<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">:FORWARD</span></span><span class="z-meta z-function-call z-arguments z-shell"> ACCEPT <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>0:0<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">:OUTPUT</span></span><span class="z-meta z-function-call z-arguments z-shell"> ACCEPT <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>0:0<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> INPUT<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> state<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>state</span> RELATED,ESTABLISHED<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> ACCEPT</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> INPUT<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> icmp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> ACCEPT</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> INPUT<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>i</span> lo<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> ACCEPT</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> INPUT<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> 140.205.201.0/24<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> DROP</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> INPUT<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span> 140.205.255.0/24<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> DROP</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> INPUT<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> tcp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> state<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>state</span> NEW<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> tcp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dport</span> 22<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> ACCEPT</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> INPUT<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> tcp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> tcp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dport</span> 80<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> ACCEPT</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> INPUT<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> tcp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> tcp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dport</span> 443<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> ACCEPT</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> INPUT<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>i</span> eth0<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> ah<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> ACCEPT</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> INPUT<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>i</span> eth0<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> esp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> ACCEPT</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> INPUT<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>i</span> eth0<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dport</span> 500<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> ACCEPT</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> INPUT<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>i</span> eth0<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> udp<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dport</span> 4500<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> ACCEPT</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> INPUT<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> REJECT<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>reject-with</span> icmp-host-prohibited</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> FORWARD<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>i</span> eth0<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> policy<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dir</span> in<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>pol</span> ipsec<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> ACCEPT</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> FORWARD<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>d</span> 10.10.0.0/24<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>o</span> eth0<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> policy<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>dir</span> out<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>pol</span> ipsec<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> ACCEPT</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-A</span></span><span class="z-meta z-function-call z-arguments z-shell"> FORWARD<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>j</span> REJECT<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>reject-with</span> icmp-host-prohibited</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">COMMIT</span></span>
</span></code></pre>
<p>重启防火墙，使规则生效。</p>
<p><code>systemctl restart iptables</code></p>
<p>配置strongswan 输出日志，方便测试，测试完成后，关闭该日志</p>
<p><code>vim /etc/strongswan/strongswan.d/charon.conf</code></p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">charon</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
    filelog <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
        charon-debug-log <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
            path = /var/log/charon_debug.log
            time_format = <span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span><span class="z-variable z-other z-readwrite z-shell">b</span></span> <span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span><span class="z-variable z-other z-readwrite z-shell">e</span></span> <span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span><span class="z-variable z-other z-readwrite z-shell">T</span></span>
            default = 2
            mgr = 0
            net = 1
            enc = 1
            asn = 1
            job = 1
            ike_name = yes
            append = no
            flush_line = yes
        <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span>
    <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span>
    <span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">这里是其它设置......</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span></code></pre>
<p>启动strongswan</p>
<p><code>systemctl start strongswan</code></p>
<h2 id="si-zui-hou-zhuang-tai-jian-cha-ji-ce-shi">四、最后状态检查 及 测试</h2>
<pre class="z-code"><code><span class="z-text z-plain">systemctl status nginx
systemctl status iptables
systemctl status strongswan
</span></code></pre>
<p>到阿里云控制台打开白名单，包含：</p>
<pre class="z-code"><code><span class="z-text z-plain">tcp 500
tcp 4500
全部 GRE
</span></code></pre>
<p>windows  macos ios 直接配置 vpn即可，</p>
<p>Android 系统需要下载客户端程序，前往官网下载 <a rel="noopener nofollow noreferrer" target="_blank" href="https://download.strongswan.org/Android/?C=M;O=D">最新版 apk 程序</a>。
测试完成后，记得关闭 strongswan 日志, 重启 strongswan。</p>
<p><code>systemctl restart strongswan</code></p>
<p>设置开机自启动，完工。</p>
<pre class="z-code"><code><span class="z-text z-plain">systemctl enable iptables
systemctl enable strongswan
</span></code></pre>
<h2 id="wu-wei-hu">五、维护</h2>
<p>查看证书情况</p>
<p><code>certbot certificates</code></p>
<p>证书手动更新</p>
<p><code>certbot renew --cert-name domain --dry-run</code></p>
<p><code>certbot --nginx certonly -n -d domain</code></p>
<p>第二种更新方法须安装 <code>python3-certbot-nginx</code></p>

<p><b><a href="#">Back to top</a></b></p>
    </article>
    <div class="toc" aria-hidden="true">
      <div class="toc-sticky">
        <h3>Index</h3>
        <div class="toc-item">
          <a class="subtext" href="https://www.freeopen.tech/centos-vpn/#yi-zhun-bei-jie-duan">一、准备阶段</a>
        </div>
        <div class="toc-item">
          <a class="subtext" href="https://www.freeopen.tech/centos-vpn/#er-shen-qing-ssl-zheng-shu">二、申请 ssl 证书</a>
        </div>
        <div class="toc-item-child">
          <a class="subtext" href="https://www.freeopen.tech/centos-vpn/#certbot-zheng-shu-zi-dong-geng-xin"><small>- Certbot 证书自动更新</small></a>
        </div>
        <div class="toc-item">
          <a class="subtext" href="https://www.freeopen.tech/centos-vpn/#san-an-zhuang-strongswan">三、安装 strongswan</a>
        </div>
        <div class="toc-item">
          <a class="subtext" href="https://www.freeopen.tech/centos-vpn/#si-zui-hou-zhuang-tai-jian-cha-ji-ce-shi">四、最后状态检查 及 测试</a>
        </div>
        <div class="toc-item">
          <a class="subtext" href="https://www.freeopen.tech/centos-vpn/#wu-wei-hu">五、维护</a>
        </div>
      </div>
    </div>
  </main>
  <footer>
    <hr />
    <div class="c">
      <nav>
        <ul><li><a href="https://www.freeopen.tech/atom.xml" target="_blank" title="Atom/RSS Feed"><i type="Button" class="svg rss" title="Atom/RSS Feed"></i></a></li><li class="js"><a class="m-protected" href="#ZnJlZW9wZW5AMTYzLmNvbQ==" target="_blank" title="Mail"><i type="Button" class="svg mail" title="Mail"></i></a></li><li><a href="https://github.com/freeopen/" target="_blank" title="Github"><i type="Button" class="svg github" title="Github"></i></a></li></ul>
      </nav>
      <p class="s90">Copyright &copy; 2023 Freeopen</p>
      <nav>
        <ul><li class="s90"> <a href="https://www.freeopen.tech/about/"> About </a> </li><li class="s90"> <a href="https://www.freeopen.tech/contact/"> Contact </a> </li><li class="s90"> <a href="https://www.freeopen.tech/privacy/"> Privacy </a> </li><li class="s90"> <a href="https://www.freeopen.tech/sitemap.xml" target="_blank"> Sitemap </a> </li></ul>
      </nav>
    </div>
  </footer>
<span class="topout">
<span class="topleft"> </span><a href="#" class="top" title="Back to Top"><i class="svgs svgh angu"></i></a>
</span>
</body>
</html>